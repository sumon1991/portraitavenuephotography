(function($){$.fn.filepicker=function(options){var defaults={onSubmit:false,btnText:"Browse files...",url:"upload.php",theme:"custom",field:"file",data:null,multi:true,showFilename:true,showPercent:true,showErrorAlerts:true,allowedExtensions:"",invalidExtError:"Invalid file type.",maxSize:0,maxFileCount:0,fileCount:0,sizeError:"File size is greater than allowed limit.",maxUploadError:"Maximum number of allowable file uploads has been exceeded.",errorMsg:"ERROR:",nonce:"",del_nonce:"",path:"",container:"",btnIcon:"fa-upload",onFileError:function(file,error){},onFileSuccess:function(file,data){}};var options=$.extend(defaults,options);var obj;var files=[];var file=new Object;var fileinput=this;this.each(function(){obj=$(this);if(options.theme=="Bootstrap"){var html='<a href="javascript:void(0)" class="btn btn-primary btn-upload btn-block"> <i style="color:inherit" class="fa '+options.btnIcon+' fa-fw"></i>'+options.btnText+'</a><div class="file-container"></div>'}else if(options.theme=="Pure"){var html='<a href="javascript:void(0)" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" style="padding:5px;font-size:90%;"><i class="fa fa-upload"></i> '+options.btnText+'</a><div class="file-container"></div>'}else if(options.theme=="custom"){var html='<a href="javascript:void(0)" class="btn-filepicker">'+options.btnText+'</a><div class="file-container"></div>'}obj.after(html);obj.hide();obj.next("a").click(function(){obj.click()});obj.change(function(){if(options.maxFileCount!=0&&options.maxFileCount<=options.fileCount){obj.attr("disabled","disabled");if(options.theme=="Bootstrap"){if(options.container){$("#"+options.container).prepend('<div class="alert alert-danger fade in alert-dismissable"><a href="#" class="close" data-dismiss="alert" aria-label="close" title="close">&times;</a><strong> '+options.errorMsg+" </strong>"+options.maxUploadError+"</div>")}else{obj.next("a").next("div").prepend('<div class="alert alert-danger fade in alert-dismissable"><a href="#" class="close" data-dismiss="alert" aria-label="close" title="close">&times;</a><strong> '+options.errorMsg+" </strong>"+options.maxUploadError+"</div>")}}else if(options.theme=="Pure"){obj.next("a").next("div").prepend('<div class="ui-state-error ui-corner-all pure-u-4-5" style="margin-bottom:5px;padding-right:10px;"><span class="close" style="float: left; margin-right: .3em;margin-left:.3em;" data-dismiss="alert">&times;</span> '+options.errorMsg+" "+options.maxUploadError+"</div>")}bootstrapclosenotification();return}for(var i=0,f;f=obj[0].files[i];i++){file.name=f.name;file.size=f.size/1024;if(validateresult()===true){if(options.onSubmit===false){UploadFile(f)}else{obj.next("a").next("div").prepend('<br /><span class="filename">'+file.name+"</span>");obj.parent("form").bind("submit",function(){obj.next("a").next("div").html("");UploadFile(f)})}}}})});$(document).on("click",".emd-editable-att-delete",function(){options.fileCount--;if(options.maxFileCount!=0&&options.maxFileCount>options.fileCount){fileinput.removeAttr("disabled")}});$(document).on("click",".filepicker-del",function(){var parent=$(this).parent("div").parent("div");del_file=parent.find(".filename-txt").text();var formData=new FormData;formData.append("action","emd_delete_file");formData.append("path",options.path);formData.append("nonce",options.del_nonce);formData.append("field",obj.attr("id"));formData.append("del_file",del_file);$.ajax({url:options.url,type:"POST",data:formData,success:function(data){options.fileCount--;parent.remove();if(options.maxFileCount!=0&&options.maxFileCount>options.fileCount){fileinput.removeAttr("disabled")}},cache:false,contentType:false,processData:false})});function UploadFile(f){var error=true;if(options.theme=="Bootstrap"){var htmlprogress='<div class="file row"><div class="col-xs-6"><div class="filename progress small"><span class="filename-txt">'+f.name+'</span></div></div><div class="col-xs-4"><div class="progress progress-striped"><div class="progress-bar progress-bar-success filepicker-progress-bar"><span class="badge badge-info"></span></div></div></div><div class="col-xs-2"><a href="javascript:void(0);" style="font-size:1.2rem;vertical-align:top;" class="text-danger filepicker-del"><i class="fa fa-trash-o fa-fw" aria-hidden="true"></i></a></div></div>'}else if(options.theme=="Pure"){var htmlprogress='<div class="file pure-g-r"><div class="filename pure-u-1-5" style="height:2em;margin-right:5px;margin-bottom:5px;overflow:hidden;"><span class="filename-txt">'+f.name+'</span></div><div class="ui-progressbar ui-widget ui-widget-content ui-corner-all pure-u-3-5"><div class="filepicker-progress-bar ui-progressbar-value ui-widget-header ui-corner-left" style="width: 0%;"><span class="badge badge-info"></span></div></div></div>'}else if(options.theme=="custom"){var htmlprogress='<div class="file"><div class="filename"></div><div class="progress-filepicker"><div class="bar-filepicker filepicker-progress-bar" style="width: 0%;"><span></span></div></div></div>'}if(options.container){$("#"+options.container).prepend(htmlprogress)}else{obj.next("a").next("div").prepend(htmlprogress)}var formData=new FormData;formData.append(options.field,f);formData.append("action","emd_load_file");formData.append("extensions",options.allowedExtensions);formData.append("path",options.path);formData.append("nonce",options.nonce);formData.append("field",obj.attr("id"));$.ajax({url:options.url,type:"POST",data:formData,success:function(data){var percent=100;if(options.container){$("#"+options.container).find(".filepicker-progress-bar:first").width(percent+"%");$("#"+options.container).find(".filepicker-progress-bar:first").text(percent+"%")}else{obj.next("a").next("div").find(".filepicker-progress-bar:first").width(percent+"%");obj.next("a").next("div").find(".filepicker-progress-bar:first").text(percent+"%")}if(data==1){files.push(f);options.fileCount++;options.onFileSuccess(f,data)}else{options.onFileError(f,data);if(options.container){$("#"+options.container).find(".file:first").remove()}else{obj.next("a").next("div").find(".file:first").remove()}if(options.theme=="Bootstrap"&&options.showErrorAlerts==true){if(options.container){$("#"+options.container).prepend('<div class="alert alert-danger fade in alert-dismissable"><a href="#" class="close" data-dismiss="alert" aria-label="close" title="close">&times;</a><strong> '+options.errorMsg+" </strong>"+file.name+" - "+data+"</div>")}else{obj.next("a").next("div").prepend('<div class="alert alert-danger fade in alert-dismissable"><a href="#" class="close" data-dismiss="alert" aria-label="close" title="close">&times;</a><strong> '+options.errorMsg+" </strong>"+file.name+" - "+data+"</div>")}bootstrapclosenotification()}else if(options.theme=="Pure"&&options.showErrorAlerts==true){obj.next("a").next("div").prepend('<div class="ui-state-error ui-corner-all pure-u-4-5" style="margin-bottom:5px;padding-right:10px;"><span class="close" style="float: left; margin-right: .3em;margin-left:.3em;" data-dismiss="alert">&times;</span> '+options.errorMsg+" "+file.name+" - "+data+"</div>");bootstrapclosenotification()}else if(options.theme=="custom"&&options.showErrorAlerts==true){obj.next("a").next("div").prepend('<div class="alert-filepicker"><button type="button" class="close" data-dismiss="alert">&times;</button> '+options.errorMsg+" "+file.name+" - "+data+"</div>");customclosenotification()}error=false}},xhr:function(){myXhr=$.ajaxSettings.xhr();if(myXhr.upload){myXhr.upload.addEventListener("progress",progressHandlingFunction,false)}return myXhr},cache:false,contentType:false,processData:false});return error}function progressHandlingFunction(e){if(e.lengthComputable){var total=e.total;var loaded=e.loaded;if(options.showPercent==true){var percent=Number((e.loaded*100/e.total).toFixed(2));if(options.container){$("#"+options.container).find(".file").first().find(".filepicker-progress-bar:first").width(percent+"%")}else{obj.next("a").next("div").find(".file").first().find(".filepicker-progress-bar:first").width(percent+"%")}}if(options.container){$("#"+options.container).find(".file").first().find(".filepicker-progress-bar:first").html("<center>"+percent+"%</center>")}else{obj.next("a").next("div").find(".file").first().find(".filepicker-progress-bar:first").html("<center>"+percent+"%</center>")}}}function validateresult(){var canUpload=true;if(options.allowedExtensions!=""){var validationresult=validateExtension();if(validationresult===false){$("#"+obj.attr("id")).val("");canUpload=false;if(options.theme=="Bootstrap"&&options.showErrorAlerts==true){if(options.container){$("#"+options.container).prepend('<div class="alert alert-danger fade in alert-dismissable"><a href="#" class="close" data-dismiss="alert" aria-label="close" title="close">&times;</a><strong> '+options.errorMsg+" </strong>"+options.invalidExtError+"</div>")}else{obj.next("a").next("div").prepend('<div class="alert alert-danger fade in alert-dismissable"><a href="#" class="close" data-dismiss="alert" aria-label="close" title="close">&times;</a><strong> '+options.errorMsg+" </strong>"+options.invalidExtError+"</div>")}bootstrapclosenotification()}else if(options.theme=="Pure"&&options.showErrorAlerts==true){obj.next("a").next("div").prepend('<div class="ui-state-error ui-corner-all pure-u-4-5" style="margin-bottom:5px;padding-right:10px;"><span class="close" style="float: left; margin-right: .3em;margin-left:.3em;"  data-dismiss="alert">&times;</span> '+options.errorMsg+" "+file.name+" - "+options.invalidExtError+"</div>");bootstrapclosenotification()}else if(options.theme=="custom"&&options.showErrorAlerts==true){obj.next("a").next("div").prepend('<div class="alert-filepicker"><button type="button" class="close">&times;</button> '+options.errorMsg+" "+file.name+" -  "+options.invalidExtError+"</div>");customclosenotification()}options.onFileError(file,options.invalidExtError)}else{canUpload=true}}if(canUpload==true&&options.maxSize>0){var validationresult=validateSize();if(validationresult===false){$("#"+obj.attr("id")).val("");canUpload=false;if(options.theme=="Bootstrap"&&options.showErrorAlerts==true){if(options.container){$("#"+options.container).prepend('<div class="alert alert-danger fade in alert-dismissable"><a href="#" class="close" data-dismiss="alert" aria-label="close" title="close">&times;</a><strong> '+options.errorMsg+" </strong>"+options.sizeError+"</div>")}else{obj.next("a").next("div").prepend('<div class="alert alert-danger fade in alert-dismissable"><a href="#" class="close" data-dismiss="alert" aria-label="close" title="close">&times;</a><strong> '+options.errorMsg+" </strong>"+options.sizeError+"</div>")}bootstrapclosenotification()}else if(options.theme=="Pure"&&options.showErrorAlerts==true){obj.next("a").next("div").prepend('<div class="ui-state-error ui-corner-all pure-u-4-5" style="margin-bottom:5px;padding-right:10px;"><span class="close" style="float: left; margin-right: .3em;margin-left:.3em;" data-dismiss="alert">&times;</span> '+options.errorMsg+" "+file.name+" - "+options.sizeError+"</div>");bootstrapclosenotification()}else if(options.theme=="custom"&&options.showErrorAlerts==true){obj.next("a").next("div").prepend('<div class="alert-filepicker"><button type="button" class="close" data-dismiss="alert">&times;</button> '+options.errorMsg+" "+file.name+" - "+options.sizeError+"</div>");customclosenotification()}options.onFileError(file,options.sizeError)}else{canUpload=true}}return canUpload}function validateExtension(){var ext=obj.val().split(".").pop().toLowerCase();var allowed=options.allowedExtensions.split(",");if($.inArray(ext,allowed)==-1){return false}else{return true}}function validateSize(){if(file.size>options.maxSize){return false}else{return true}}function bootstrapclosenotification(){if(options.container){$("#"+options.container).find(".ui-state-error").click(function(){$(this).remove()})}else{obj.next("a").next("div").find(".ui-state-error").click(function(){$(this).remove()})}}function customclosenotification(){if(options.container){$("#"+options.container).find(".alert-filepicker").click(function(){$(this).remove()})}else{obj.next("a").next("div").find(".alert-filepicker").click(function(){$(this).remove()})}}}})(jQuery);
